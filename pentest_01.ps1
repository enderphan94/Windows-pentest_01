#Dev by Ender Loc Phan
<#Requirements:
    Powershell 4.0 
    Import-Module ActiveDirectory
#>
<#
.Synopsis
   Pentesting tool in windows
   
   Checking for: 
       + None-Delegated Kerberos Accounts
       + Delegated Kerberos Accounts.
       + NTML 
       + NTML audit
       + LSA
       + Wdigest
       + SMB/SMB signing 
       + Sysvol Replication Machanism
       

.DESCRIPTION

.LINK
    https://github.com/enderphan94/Windows-pentest_01
#>
$domain = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$computer = $($env:COMPUTERNAME)
Write-host "`nPENTESTING ON" -ForegroundColor Cyan
write-host "Domain: $($domain.name)" -ForegroundColor Cyan
Write-Host "Computer: $computer`n" -ForegroundColor Cyan
$file_time = (Get-Date).ToString("yyyy-MM-dd-ss")
$global:save_file = $($MyInvocation.MyCommand.Path)+"None-delegated AccountsReport-$($file_time).csv"
$outFileHTML= $($MyInvocation.MyCommand.Path)+"None-delegated AccountsReport-$($file_time).html"
$Delimiter = ","

function main{
    param(
    [String]$genres,
    [String]$name,
    [switch]$lsa,
    [switch]$wdigest,
    [switch]$smb,
    [switch]$sysvol
    
    )
    [xml]$xml = Get-GPOReport -all -ReportType Xml

    $arra_lsa =  New-Object System.Collections.ArrayList
    $arra_ntml = New-Object System.Collections.ArrayList
    foreach($GPO in @($xml.GPOS.GPO)){
        if($lsa -ne $true){
            $checkntlm = $GPO.computer.ExtensionData.Extension.SecurityOptions.Display|select @{Name="GPO";Expression={$GPO.Name}}, Name, DisplayString,DisplayBoolean| ? {$_.Name -match "^$($genres):"} 
            $arra_ntml.Add($checkntlm)|Out-Null
        }
        else{

            $checklsa = $GPO.computer.ExtensionData.Extension.SecurityOptions|select @{Name="GPO";Expression={$GPO.Name}}, KeyName,SettingNumber |? {$_.KeyName -match "RunAsPPL"} |Format-Table
            $arra_lsa.Add($checklsa)|Out-Null
        }
        if($smb -eq $true){
            
            $GPO.computer.ExtensionData.Extension.SecurityOptions.Display|`
             select @{Name="GPO";Expression={$GPO.Name}}, Name,DisplayBoolean |? {($_.Name -match "Microsoft network server") -or ($_.Name -match "Microsoft network client")}  
        }
    }
    
    if($arra_ntml -eq ""){
         Write-Host "$name isn't enabled" -ForegroundColor Gray    
    }else{
        $arra_ntml
    }


    if($lsa -eq $true){
        if ($arra_lsa -eq ""){
            Write-Host "LSA isn't enabled" -ForegroundColor Gray
        }
        else{
            Write-Host "LSA is enabled" -ForegroundColor Gray
            $arra_lsa
        }
    }

    if($wdigest -eq $true){

        $digest= Get-ItemProperty "hklm:\SYSTEM\CurrentControlSet\Control\SecurityProviders\Wdigest\"
        if($digest.UseLogonCredential -eq $null){
  
            Write-Host "Wdigest Authentication isn't enabled" -ForegroundColor gray
        }
        else{
            Write-Host "Wdigest Authentication is enabled" -ForegroundColor gray        
        }
    }

    if($sysvol -eq $true){
        $currentDomain =(Get-ADDomainController).hostname

        $defaultNamingContext = (([ADSI]"LDAP://$currentDomain/rootDSE").defaultNamingContext)
        $searcher = New-Object DirectoryServices.DirectorySearcher
        $searcher.Filter = "(&(objectClass=computer)(dNSHostName=$currentDomain))"
        $searcher.SearchRoot = "LDAP://" + $currentDomain + "/OU=Domain Controllers," + $defaultNamingContext
        $dcObjectPath = $searcher.FindAll() | %{$_.Path}

        # DFSR
        $searchDFSR = New-Object DirectoryServices.DirectorySearcher
        $searchDFSR.Filter = "(&(objectClass=msDFSR-Subscription)(name=SYSVOL Subscription))"
        $searchDFSR.SearchRoot = $dcObjectPath
        $dfsrSubObject = $searchDFSR.FindAll()

        if ($dfsrSubObject -ne $null){

            [pscustomobject]@{
                "SYSVOL Replication Mechanism"= "DFSR"
                "Path:"= $dfsrSubObject|%{$_.Properties."msdfsr-rootpath"}
            }
    
        }

        # FRS
        $searchFRS = New-Object DirectoryServices.DirectorySearcher
        $searchFRS.Filter = "(&(objectClass=nTFRSSubscriber)(name=Domain System Volume (SYSVOL share)))"
        $searchFRS.SearchRoot = $dcObjectPath
        $frsSubObject = $searchFRS.FindAll()

        if($frsSubObject -ne $null){
    
            [pscustomobject]@{
                "SYSVOL Replication Mechanism" = "FRS"
                "Path" = $frsSubObject|%{$_.Properties.frsrootpath}
            }

        }
    }
    
}
function kbr{

    #List of Delegated accounts, which includes user, computer accounts 

  
[string]$DN = (Get-ADDomain).DistinguishedName

 
$SERVER_TRUST_ACCOUNT = 0x2000
$TRUSTED_FOR_DELEGATION = 0x80000
$TRUSTED_TO_AUTH_FOR_DELEGATION= 0x1000000
$PARTIAL_SECRETS_ACCOUNT = 0x4000000  
$bitmask = $TRUSTED_FOR_DELEGATION -bor $TRUSTED_TO_AUTH_FOR_DELEGATION -bor $PARTIAL_SECRETS_ACCOUNT
 
# LDAP filter to find all accounts having some form of delegation.
# 1.2.840.113556.1.4.804 is an OR query. 
$filter = @"
(&
  (servicePrincipalname=*)
  (|
    (msDS-AllowedToActOnBehalfOfOtherIdentity=*)
    (msDS-AllowedToDelegateTo=*)
    (UserAccountControl:1.2.840.113556.1.4.804:=$bitmask)
  )
  (|
    (objectcategory=computer)
    (objectcategory=person)
    (objectcategory=msDS-GroupManagedServiceAccount)
    (objectcategory=msDS-ManagedServiceAccount
    )
  )
)
"@ -replace "[\s\n]", ''
<#

    #>
$propertylist = @(
    "servicePrincipalname", 
    "useraccountcontrol", 
    "samaccountname", 
    "msDS-AllowedToDelegateTo", 
    "msDS-AllowedToActOnBehalfOfOtherIdentity"
)
Get-ADObject -LDAPFilter $filter -SearchBase $DN -SearchScope Subtree -Properties $propertylist -PipelineVariable account | ForEach-Object {
    $isDC = ($account.useraccountcontrol -band $SERVER_TRUST_ACCOUNT) -ne 0
    $fullDelegation = ($account.useraccountcontrol -band $TRUSTED_FOR_DELEGATION) -ne 0
    $constrainedDelegation = ($account.'msDS-AllowedToDelegateTo').count -gt 0
    $isRODC = ($account.useraccountcontrol -band $PARTIAL_SECRETS_ACCOUNT) -ne 0
    $resourceDelegation = $account.'msDS-AllowedToActOnBehalfOfOtherIdentity' -ne $null
     
    $comment = "" 
    if ((-not $isDC) -and $fullDelegation) { 
        $comment += "WARNING: full delegation to non-DC is not recommended!; " 
    }
    if ($isRODC) { 
        $comment += "WARNING: investigation needed if this is not a real RODC; " 
    }
    if ($resourceDelegation) { 
        # to count it using PS, we need the object type to select the correct function... broken, but there we are. 
        $comment += "INFO: Account allows delegation FROM other server(s); " 
    }
    if ($constrainedDelegation) { 
        $comment += "INFO: constrained delegation service count: $(($account.'msDS-AllowedToDelegateTo').count); " 
    }
    #[psCustomobject]
    
    return  [pscustomobject]@{
        samaccountname = $account.samaccountname
        objectClass = $account.objectclass        
        uac = ('{0:x}' -f $account.useraccountcontrol)
        isDC = $isDC
        isRODC = $isRODC
        fullDelegation = $fullDelegation
        constrainedDelegation = $constrainedDelegation
        resourceDelegation = $resourceDelegation
        comment = $comment     
    }
} 

}

Function none_delega{

    $ADSearch = New-Object System.DirectoryServices.DirectorySearcher
    $ADSearch.SearchRoot ="LDAP://$Domain"
    $ADSearch.SearchScope = "subtree"
    $ADSearch.PageSize = 100
    $ADSearch.Filter = "(objectClass=user)"
    $properies =@("distinguishedName",
    "sAMAccountName",
    "userAccountControl",
    "Description"
    )

    foreach($pro in $properies)
    {
        $ADSearch.PropertiesToLoad.add($pro)|out-null
    }

    $userObjects = $ADSearch.FindAll()
    $global:count = 0
    $check_save_file = $false

    foreach($user in $userObjects){
        $dn =  $user.properties.Item("distinguishedName")[0]
        $sam = $user.Properties.Item("sAMAccountName")[0]
        $accountDis= $user.Properties.Item("userAccountControl")[0]
        $Description = $user.Properties.item("Description")[0]
        
        if($accountDis -band 0x1000000){       
            if($ask -eq $true){

                $obj = New-Object -TypeName psobject 
                $obj | Add-Member -MemberType NoteProperty -Name "DistinguishedName" -Value $dn
                $obj | Add-Member -MemberType NoteProperty -Name "sammaAccountName" -Value $sam
                $obj | Add-Member -MemberType NoteProperty -Name "Description" -Value $Description
                $obj | Export-Csv -Path "$global:save_file" -NoTypeInformation -append -Delimiter $Delimiter
                $check_save_file = $true
            }
            elseif ($ask -eq $false)
            {
                [PSCustomobject] @{
                    samaAccountName = $sam
                    Description = $Description
                    UserAccountControl = $accountDis
                }
            }
          
            $global:count++
        }
    }

    Write-Host "Total of accounts has none-delegation: $global:count`n" -ForegroundColor "magenta"
    
    if($check_save_file -eq $true){
        Write-Host "The file has been exported to $save_file`n" -foregroundcolor "magenta"
    }

}
write-host "- Kerberos None-Delegated Accounts & DCs `n"-ForegroundColor Green 
kbr
Write-Host "- Kerberos None-Delegated Accounts `n" -ForegroundColor Green

$ask = Read-Host -Prompt  "Do you want to export the data to CSV file? (Enter/n)"

if($ask -eq ""){
    $ask = $true
}
elseif($ask -eq "n"){
    $ask = $false
}
else{
    Write-Host "I don't understand the input" -ForegroundColor Red
}
none_delega

Write-Host "- NTML`n" -ForegroundColor Green
main -genres "Network security" -name "NTML"
Write-Host

Write-Host "- NTML Audit`n" -ForegroundColor Green
main -genres "Audit" -name "NTML Audit"
Write-Host

Write-Host "- LSA" -ForegroundColor Green 
main -genres "Audit" -lsa $true
Write-Host

Write-Host "- Wdigest Authentication" -ForegroundColor Green 
main  -wdigest $true
Write-Host

Write-Host "- SMB/SMb signing`n" -ForegroundColor Green 
main -smb $true
Write-Host

Write-Host "- Syvol Replication Machanism" -ForegroundColor Green 
main -sysvol $true
