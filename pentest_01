#Dev by Ender Loc Phan
<#Requirements:
    Powershell 4.0 
    Import-Module ActiveDirectory
#>
<#
.Synopsis
   Pentesting tool in windows
   
   Checking for: 
       + NTML 
       + NTML audit
       + LSA
       + Wdigest
       + SMB/SMB signing 

.DESCRIPTION

.LINK
    https://github.com/enderphan94/Windows-pentest_01
#>
$domain = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$computer = $($env:COMPUTERNAME)
Write-host "`nPENTESTING ON" -ForegroundColor Cyan
write-host "Domain: $($domain.name)" -ForegroundColor Cyan
Write-Host "Computer: $computer`n" -ForegroundColor Cyan
function main{
    param(
    [String]$genres,
    [String]$name,
    [switch]$lsa,
    [switch]$wdigest,
    [switch]$smb
    )
    [xml]$xml = Get-GPOReport -all -ReportType Xml

    $arra_lsa =  New-Object System.Collections.ArrayList
    $arra_ntml = New-Object System.Collections.ArrayList
    foreach($GPO in @($xml.GPOS.GPO)){
        if($lsa -ne $true){
            $checkntlm = $GPO.computer.ExtensionData.Extension.SecurityOptions.Display|select @{Name="GPO";Expression={$GPO.Name}}, Name ,DisplayBoolean| ? {$_.Name -match "^$($genres):"} 
            $arra_ntml.Add($checkntlm)|Out-Null
        }
        else{

            $checklsa = $GPO.computer.ExtensionData.Extension.SecurityOptions|select @{Name="GPO";Expression={$GPO.Name}}, KeyName,SettingNumber |? {$_.KeyName -match "RunAsPPL"} |Format-Table
            $arra_lsa.Add($checklsa)|Out-Null
        }
        if($smb -eq $true){
            
            $GPO.computer.ExtensionData.Extension.SecurityOptions.Display|`
             select @{Name="GPO";Expression={$GPO.Name}}, Name,DisplayBoolean |? {($_.Name -match "Microsoft network server") -or ($_.Name -match "Microsoft network client")}  
        }
    }
    
    if($arra_ntml -eq ""){
         Write-Host "$name isn't enabled" -ForegroundColor Gray    
    }else{
        $arra_ntml
    }


    if($lsa -eq $true){
        if ($arra_lsa -eq ""){
            Write-Host "LSA isn't enabled" -ForegroundColor Gray
        }
        else{
            Write-Host "LSA is enabled" -ForegroundColor Gray
            $arra_lsa
        }
    }

    if($wdigest -eq $true){

        $digest= Get-ItemProperty "hklm:\SYSTEM\CurrentControlSet\Control\SecurityProviders\Wdigest\"
        if($digest.UseLogonCredential -eq $null){
  
            Write-Host "Wdigest Authentication isn't enabled" -ForegroundColor gray
        }
        else{
            Write-Host "Wdigest Authentication is enabled" -ForegroundColor gray        
        }
    }
    
}

Write-Host "- NTML" -ForegroundColor Green
main -genres "Network security" -name "NTML"
Write-Host
Write-Host "- NTML Audit`n" -ForegroundColor Green
main -genres "Audit" -name "NTML Audit"
Write-Host
Write-Host "- LSA" -ForegroundColor Green 
main -genres "Audit" -lsa $true
Write-Host
Write-Host "- Wdigest Authentication" -ForegroundColor Green 
main  -wdigest $true
Write-Host
Write-Host "- SMB/SMb signing`n" -ForegroundColor Green 
main -smb $true
